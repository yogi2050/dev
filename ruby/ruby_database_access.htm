<!doctype html> 
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]> <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]> <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]> <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--><html lang="en"><!--<![endif]-->

<!-- Mirrored from www.tutorialspoint.com/ruby/ruby_database_access.htm by HTTrack Website Copier/3.x [XR&CO'2010], Sat, 13 Apr 2013 19:45:55 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
<meta charset="utf-8">
<title>Ruby/DBI Tutorial</title>
<link rel="shortcut icon" href="../favicon.png" type="image/x-icon" />
<meta name="Keywords" content="Ruby, Tutorials, Learning, Beginners, Basics, Scripting Language, Syntax, Classes, , Variables, Comments, Loops, File, I/O, Functions, Objects, TK, Ranges, iterators, arrays, strings, methods, blocks, Exception, Multi-Threading, Hashes, Modules, LDAP, Web Services, Web Programming." />
<meta name="description" content="Ruby/DBI Tutorial - Learning Ruby in simple and easy steps - A beginner's tutorial containing complete knowledge of Ruby Syntax Syntax, Classes, , Variables, Comments, Loops, File, I/O, Functions, Objects, TK, Ranges, iterators, arrays, strings, methods, blocks, Exception, Multi-Threading, Hashes, Modules, LDAP, Web Services, Web Programming." />
<base  />
<link rel="stylesheet" type="text/css" href="../scripts/style.css" />
<link rel="stylesheet" type="text/css" href="../scripts/prettify.css" />
<script type="text/javascript" src="../scripts/prettify.js"></script>
<style media="screen" type="text/css">
/* Ruby Scheme */
#topmenu a:link {text-decoration:none;color:#fff !important;background-color:transparent;font-weight:bold;}
#topmenu a:visited {text-decoration:none;color:#fff !important;background-color:transparent;font-weight:bold;}
#topmenu a:hover {text-decoration:none;color:#C83932 !important;background-color:transparent;font-weight:bold;}
#header{ 
background:#C83932 !important;
}
#topmenu
{
background-color:#5E0500 !important;
}
#leftcol ul.menu li.heading 
{
background:#C83932 !important;
border:1px solid #964800 !important;
}
#leftcol, #middlecol, #rightcol {min-height:1500px; padding:0px;}
</style>
<script src="../../www.google-analytics.com/urchin.js" type="text/javascript">
</script>
<script type="text/javascript">
_uacct = "UA-232293-6";
urchinTracker();
</script>
</head>
<body onload="prettyPrint()">
<div id="header">
<div class="wrapper">
<h1 class="logo"><a href="../index.htm">Tutorials Point - Simply Easy Learning</a></h1>
<div id="search">
<form method="get" id="searchform" name="searchform" action="http://www.google.com/search" target="_blank">
<input type="hidden" name="sitesearch" value="www.tutorialspoint.com"/>
<input type="text" name="as_q" id="s" value="Search this site..." onfocus="if (this.value == 'Search this site...') {this.value = '';}" onblur="if (this.value == '') {this.value = 'Search this site...';}"/>
<input value="FORID:11" name="cof" type="hidden"/>
<input type="hidden" name="ie" value="ISO-8859-1" />
<input class="submit btn" type="image" src="../images/icon-search.png" alt="Go"/>
</form>
</div>
</div>
</div>
<div id="topmenu">
<div class="wrapper">
<div id="left">
<a href="../index.htm" target="_top">HOME </a>
<a href="../java/index.htm" target="_top">JAVA </a>
<a href="../php/index.htm" target="_top">PHP </a>
<a href="../python/index.htm" target="_top">Python </a>
<a href="index.htm" target="_top">Ruby </a>
<a href="../perl/index.htm" target="_top">Perl </a>
<a href="../html/index.htm" target="_top">HTML </a>
<a href="../css/index.htm" target="_top">CSS </a>
<a href="../javascript/index.htm" target="_top">Javascript </a>
<a href="../mysql/index.htm" target="_top">MySQL </a>
<a href="../cplusplus/index.htm" target="_top">C++ </a>
<a href="../unix/index.htm" target="_top">UNIX </a>
<a href="../more.htm" target="_top">MORE...</a>
</div>
<div id="right">
<a href="../references.htm" target="_top">REFERENCES</a> |
<a href="../forums/index.html" target="_top">FORUM</a> |
<a href="../about/index.htm" target="_top">ABOUT</a> |
<a href="../about/contact_us.htm" target="_top">CONTACT</a>
</div>
</div>
</div>
<div class="wrapper">
<div id="leftcol">
<div class="mini-logo">
<img src="../images/ruby-mini-logo.png" alt="Ruby Tutorial" />
</div>
<ul class="menu">
<li class="heading">Ruby Basics</li>
<li><a class="left" target="_top" href="index.htm">Ruby Home</a></li>
<li><a class="left" target="_top" href="ruby_overview.htm">Ruby Overview</a></li>
<li><a class="left" target="_top" href="ruby_environment.htm">Ruby Environment</a></li>
<li><a class="left" target="_top" href="ruby_syntax.htm">Ruby Syntax</a></li>
<li><a class="left" target="_top" href="ruby_classes.htm">Ruby Classes</a></li>
<li><a class="left" target="_top" href="ruby_variables.htm">Ruby Variables</a></li>
<li><a class="left" target="_top" href="ruby_operators.htm">Ruby Operators</a></li>
<li><a class="left" target="_top" href="ruby_comments.htm">Ruby Comments</a></li>
<li><a class="left" target="_top" href="ruby_if_else.htm">Ruby IF...ELSE</a></li>
<li><a class="left" target="_top" href="ruby_loops.htm">Ruby Loops</a></li>
<li><a class="left" target="_top" href="ruby_methods.htm">Ruby Methods</a></li>
<li><a class="left" target="_top" href="ruby_blocks.htm">Ruby Blocks</a></li>
<li><a class="left" target="_top" href="ruby_modules.htm">Ruby Modules</a></li>
<li><a class="left" target="_top" href="ruby_strings.htm">Ruby Strings</a></li>
<li><a class="left" target="_top" href="ruby_arrays.htm">Ruby Arrays</a></li>
<li><a class="left" target="_top" href="ruby_hashes.htm">Ruby Hashes</a></li>
<li><a class="left" target="_top" href="ruby_date_time.htm">Ruby Date &amp; Time</a></li>
<li><a class="left" target="_top" href="ruby_ranges.htm">Ruby Ranges</a></li>
<li><a class="left" target="_top" href="ruby_iterators.htm">Ruby Iterators</a></li>
<li><a class="left" target="_top" href="ruby_input_output.htm">Ruby File I/O</a></li>
<li><a class="left" target="_top" href="ruby_exceptions.htm">Ruby Exceptions</a></li>
</ul>
<ul class="menu">
<li class="heading">Ruby Advanced</li>
<li><a class="left" target="_top" href="ruby_object_oriented.htm">Ruby Object Oriented</a></li>
<li><a class="left" target="_top" href="ruby_regular_expressions.htm">Ruby Regular Expressions</a></li>
<li><a class="left" target="_top" href="ruby_database_access.htm"><b>Ruby Database Access</b></a></li>
<li><a class="left" target="_top" href="ruby_web_applications.htm">Ruby Web Applications</a></li>
<li><a class="left" target="_top" href="ruby_sending_email.htm">Ruby Sending Email</a></li>
<li><a class="left" target="_top" href="ruby_socket_programming.htm">Ruby Socket Programming</a></li>
<li><a class="left" target="_top" href="ruby_xml_xslt.htm">Ruby/XML, XSLT</a></li>
<li><a class="left" target="_top" href="ruby_web_services.htm">Ruby Web Services</a></li>
<li><a class="left" target="_top" href="ruby_tk_guide.htm">Ruby/Tk Guide</a></li>
<li><a class="left" target="_top" href="ruby_ldap.htm">Ruby/LDAP Tutorial</a></li>
<li><a class="left" target="_top" href="ruby_multithreading.htm">Ruby Multithreading</a></li>
</ul>
<ul class="menu">
<li class="heading">Ruby Useful Resources</li>
<li><a class="left" target="_top" href="ruby_quick_guide.htm">Ruby Quick Guide</a></li>
<li><a class="left" target="_top" href="ruby_builtin_functions.htm">Ruby Built-in Functions</a></li>
<li><a class="left" target="_top" href="ruby_predefined_variables.htm">Ruby Predefined Variables</a></li>
<li><a class="left" target="_top" href="ruby_predefined_constants.htm">Ruby Predefined Constants</a></li>
<li><a class="left" target="_top" href="ruby_associated_tools.htm">Ruby Associated Tools</a></li>
<li><a class="left" target="_top" href="ruby_resources.htm">Ruby Useful Resources</a></li>
<li><a class="left" target="_top" href="../ruby-on-rails/index.htm">Ruby on Rails Tutorial</a></li>
</ul>
<ul class="menu">
<li class="sreading">Selected Reading</li>
<li><a target="_top" href="../developers_best_practices/index.htm">Developer's Best Practices</a></li>
<li><a target="_top" href="../computer_glossary.htm">Computer Glossary</a></li>
<li><a target="_top" href="../computer_whoiswho.htm">Who is Who</a></li>
</ul>
</div><!-- leftcol -->
<div id="middlecol">
<!-- PRINTING STARTS HERE -->
<div class="content">
<h1>Ruby/DBI Tutorial</h1>
<div class="topgooglead">
<div style="padding-bottom:5px;padding-left:10px;">Advertisements</div>
<script type="text/javascript"><!--
google_ad_client = "pub-7133395778201029";
google_ad_width = 468;
google_ad_height = 60;
google_ad_format = "468x60_as";
google_ad_type = "image";
google_ad_channel = "";
//--></script>
<script type="text/javascript"
src="../../pagead2.googlesyndication.com/pagead/show_ads.js"> 
</script>
</div>
<hr />
<div class="pre-btn">
<a href="ruby_regular_expressions.htm">Previous Page</a>
</div>
<div class="nxt-btn">
<a href="ruby_web_applications.htm">Next Page</a>
</div>
<div class="clearer"></div>
<hr />
<p>This session will teach you how to access a database using Ruby. The <i>Ruby DBI</i> module provides a database-independent interface for Ruby scripts similar to that of the Perl DBI module.</p>
<p>DBI stands for Database independent interface for Ruby which means DBI provides an abstraction layer between the Ruby code and the underlying database, allowing you to switch database implementations really easily. It defines a set of methods, variables, and conventions that provide a consistent database interface, independent of the actual database being used.</p>
<p>DBI can interface with the following:</p>
<ul class="list">
<li><p>ADO (ActiveX Data Objects)</p></li>
<li><p>DB2</p></li>
<li><p>Frontbase</p></li>
<li><p>mSQL</p></li>
<li><p>MySQL</p></li>
<li><p>ODBC</p></li>
<li><p>Oracle</p></li>
<li><p>OCI8 (Oracle)</p></li>
<li><p>PostgreSQL</p></li>
<li><p>Proxy/Server</p></li>
<li><p>SQLite</p></li>
<li><p>SQLRelay</p></li>
</ul>
<h2>Architecture of a DBI Application</h2>
<p>DBI is independent of any database available in backend. You can use DBI whether you are working with Oracle, MySQL or Informix etc. This is clear from the following architure diagram.</p>
<img src="../images/ruby_dbi.jpg" alt="Ruby DBI Architecture" />
<p>The general architecture for Ruby DBI uses two layers:</p>
<ul class="list">
<li><p>The database interface (DBI) layer. This layer is database independent and provides a set of common access methods that are used the same way regardless of the type of database server with which you're communicating.</p></li>
<li><p>The database driver (DBD) layer. This layer is database dependent; different drivers provide access to different database engines. There is one driver for MySQL, another for PostgreSQL, another for InterBase, another for Oracle, and so forth. Each driver interprets requests from the DBI layer and maps them onto requests appropriate for a given type of database server.</p></li>
</ul>
<h2>Prerequisites:</h2>
<p>If you want to write Ruby scripts to access MySQL databases, you'll need to have the Ruby MySQL module installed.</p>
<p>This module acts as a DBD as explained above and can be downloaded from http://www.tmtm.org/en/mysql/ruby/</p>
<h2>Obtaining and Installing Ruby/DBI:</h2>
<p>You can download and install the Ruby DBI module from the following location:</p>
<table class="src">
<tr><td>
<a href="http://rubyforge.org/projects/ruby-dbi/" target="_blank">http://rubyforge.org/projects/ruby-dbi/</a>
</td></tr>
</table>
<p>Before starting this installation make sure you have root privilege. Now following the following steps:</p>
<h2>Step 1</h2>
<pre class="prettyprint">
$ tar zxf dbi-0.2.0.tar.gz
</pre>
<h2>Step 2</h2>
<p>Go in distrubution directory <i>dbi-0.2.0</i> and configure it using the <i>setup.rb</i> script in that directory. The most general configuration command looks like this, with no arguments following the config argument. This command configures the distribution to install all drivers by default.</p>
<pre class="prettyprint">
$ ruby setup.rb config
</pre>
<p>To be more specific, provide a --with option that lists the particular parts of the distribution you want to use. For example, to configure only the main DBI module and the MySQL DBD-level driver, issue the following command:</p>
<pre class="prettyprint">
$ ruby setup.rb config --with=dbi,dbd_mysql
</pre>
<h2>Step 3</h2>
<p>Final step is to build the driver and install it using the following commands.</p>
<pre class="prettyprint">
$ ruby setup.rb setup
$ ruby setup.rb install
</pre>
<h2>Database Connection:</h2>
<p>Assuming we are going to work with MySQL database. Before connecting to a database make sure followings:</p>
<ul class="list">
<li><p>You have created a database TESTDB.</p></li>
<li><p>You have created EMPLOYEE in TESTDB.</p></li>
<li><p>This table is having fields FIRST_NAME, LAST_NAME, AGE, SEX and INCOME.</p></li>
<li><p>User ID "testuser" and password "test123" are set to access TESTDB</p></li>
<li><p>Ruby Module DBI is installed properly on your machine.</p></li>
<li><p>You have gone through MySQL tutorial to understand MySQL Basics.</p>
</li>
</ul>
<p>Following is the example of connecting with MySQL database "TESTDB"</p>
<pre class="prettyprint">
#!/usr/bin/ruby -w

require "dbi"

begin
     # connect to the MySQL server
     dbh = DBI.connect("DBI:Mysql:TESTDB:localhost", 
	                    "testuser", "test123")
     # get server version string and display it
     row = dbh.select_one("SELECT VERSION()")
     puts "Server version: " + row[0]
rescue DBI::DatabaseError =&gt; e
     puts "An error occurred"
     puts "Error code:    #{e.err}"
     puts "Error message: #{e.errstr}"
ensure
     # disconnect from server
     dbh.disconnect if dbh
end
</pre>
<p>While running this script, its producing following result at my Linux machine.</p>
<pre class="prettyprint">
Server version: 5.0.45
</pre>
<p>If a connection is established with the datasource then a Database Handle is returned and saved into <b>dbh</b> for further use otherwise <b>dbh</b> is set to nill value and <i>e.err</i> and <i>e::errstr</i> return error code and an error string respectively.</p>
<p>Finally before coming out it ensures that database connection is closed and resources are released.</p>
<h2>INSERT Operation:</h2>
<p>INSERT operation is required when you want to create your records into a database table.</p>
<p>Once a database connection is established, we are ready to create tables or records into the database tables using <b>do</b> method or <b>prepare</b> and <b>execute</b> method.</p>
<h2>Using do Statement:</h2>
<p>Statements that do not return rows can be issued by invoking the <b>do</b> database handle method. This method takes a statement string argument and returns a count of the number of rows affected by the statement. </p>
<pre class="prettyprint">
dbh.do("DROP TABLE IF EXISTS EMPLOYEE")
dbh.do("CREATE TABLE EMPLOYEE (
     FIRST_NAME  CHAR(20) NOT NULL,
     LAST_NAME  CHAR(20),
     AGE INT,  
     SEX CHAR(1),
     INCOME FLOAT )" );
</pre>
<p>Similar way you can execute SQL <i>INSERT</i> statement to create a record into EMPLOYEE table.</p>
<pre class="prettyprint">
#!/usr/bin/ruby -w

require "dbi"

begin
     # connect to the MySQL server
     dbh = DBI.connect("DBI:Mysql:TESTDB:localhost", 
	                    "testuser", "test123")
     dbh.do( "INSERT INTO EMPLOYEE(FIRST_NAME,
                   LAST_NAME, 
                   AGE, 
		   SEX, 
		   INCOME)
          VALUES ('Mac', 'Mohan', 20, 'M', 2000)" )
     puts "Record has been created"
     dbh.commit
rescue DBI::DatabaseError =&gt; e
     puts "An error occurred"
     puts "Error code:    #{e.err}"
     puts "Error message: #{e.errstr}"
     dbh.rollback
ensure
     # disconnect from server
     dbh.disconnect if dbh
end
</pre>
<h2>Using <i>prepare</i> and <i>execute</i>:</h2>
<p>You can use <i>prepare</i> and <i>execute</i> methods of DBI class to execute SQL statement through Ruby code.</p>
<p>Record creation takes following steps</p>
<ul class="list">
<li><p>Prearing SQL statement with INSERT statement. This will be done using <b>prepare</b> method.</p></li>
<li><p>Executing SQL query to select all the results from the database. This will be done using <b>execute</b> method.</p></li>
<li><p>Releasing Stattement handle. This will be done using <b>finish</b> API</p></li>
<li><p>If everything goes fine then <b>commit</b> this operation otherwise you can <b>rollback</b> complete transaction.</p></li>
</ul>
<p>Following is the syntax to use these two methods:</p>
<pre class="prettyprint">
sth = dbh.prepare(statement)
sth.execute
   ... zero or more SQL operations ...
sth.finish
</pre>
<p>These two methods can be used to pass <b>bind</b> values to SQL statements. There may be a case when values to be entered is not given in advance. In such case binding values are used. A question mark (<b>?</b>) is used in place of actual value and then actual values are passed through execute() API.</p>
<p>Following is the example to create two records in EMPLOYEE table.</p>
<pre class="prettyprint">
#!/usr/bin/ruby -w

require "dbi"

begin
     # connect to the MySQL server
     dbh = DBI.connect("DBI:Mysql:TESTDB:localhost", 
	                    "testuser", "test123")
     sth = dbh.prepare( "INSERT INTO EMPLOYEE(FIRST_NAME,
                   LAST_NAME, 
                   AGE, 
 		   SEX, 
		   INCOME)
                   VALUES (?, ?, ?, ?, ?)" )
     sth.execute('John', 'Poul', 25, 'M', 2300)
     sth.execute('Zara', 'Ali', 17, 'F', 1000)
     sth.finish
     dbh.commit
     puts "Record has been created"
rescue DBI::DatabaseError =&gt; e
     puts "An error occurred"
     puts "Error code:    #{e.err}"
     puts "Error message: #{e.errstr}"
     dbh.rollback
ensure
     # disconnect from server
     dbh.disconnect if dbh
end
</pre>
<p>If there are multiple INSERTs at a time then preparing a statement first and then executing it multiple times within a loop is more efficient than invoking do each time through the loop</p>
<h2>READ Operation:</h2>
<p>READ Operation on any databasse means to fetch some useful information from the database.</p>
<p>Once our database connection is established, we are ready to make a query into this database. We can use either <b>do</b> method or <b>prepare</b> and <b>execute</b> methods to fetech values from a database table.</p>
<p>Record fetching takes following steps</p>
<ul class="list">
<li><p>Prearing SQL query based on required conditions. This will be done using <b>prepare</b> method.</p></li>
<li><p>Executing SQL query to select all the results from the database. This will be done using <b>execute</b> method.</p></li>
<li><p>Fetching all the results one by one and printing those results. This will be done using <b>fetch</b> method.</p></li>
<li><p>Releasing Stattement handle. This will be done using <b>finish</b> method.</p></li>
</ul>
<p>Following is the procedure to query all the records from EMPLOYEE table having salary more than 1000.</p>
<pre class="prettyprint">
#!/usr/bin/ruby -w

require "dbi"

begin
     # connect to the MySQL server
     dbh = DBI.connect("DBI:Mysql:TESTDB:localhost", 
	                    "testuser", "test123")
     sth = dbh.prepare("SELECT * FROM EMPLOYEE 
                        WHERE INCOME &gt; ?")
     sth.execute(1000)

     sth.fetch do |row|
        printf "First Name: %s, Last Name : %s\n", row[0], row[1]
        printf "Age: %d, Sex : %s\n", row[2], row[3]
        printf "Salary :%d \n\n", row[4]
     end
     sth.finish
rescue DBI::DatabaseError =&gt; e
     puts "An error occurred"
     puts "Error code:    #{e.err}"
     puts "Error message: #{e.errstr}"
ensure
     # disconnect from server
     dbh.disconnect if dbh
end
</pre>
<p>This will produce following result:</p>
<pre class="prettyprint">
First Name: Mac, Last Name : Mohan
Age: 20, Sex : M
Salary :2000

First Name: John, Last Name : Poul
Age: 25, Sex : M
Salary :2300
</pre>
<p>There are more shot cut methods to fecth records from the database. If you are interested then go through <a href="ruby_dbi_fetching_results.htm" title="Ruby DBI Read Operation">Fetching the Result</a> otherwise proceed to next section.</p>
<h2>Update Operation:</h2>
<p>UPDATE Operation on any databasse means to update one or more records which are already available in the database. Following is the procedure to update all the records having SEX as 'M'. Here we will increase AGE of all the males by one year. This will take three steps</p>
<ul class="list">
<li><p>Prearing SQL query based on required conditions. This will be done using <b>prepare</b> method.</p></li>
<li><p>Executing SQL query to select all the results from the database. This will be done using <b>execute</b> method.</p></li>
<li><p>Releasing Stattement handle. This will be done using <b>finish</b> method.</p></li>
<li><p>If everything goes fine then <b>commit</b> this operation otherwise you can <b>rollback</b> complete transaction.</p></li>
</ul>
<pre class="prettyprint">
#!/usr/bin/ruby -w

require "dbi"

begin
     # connect to the MySQL server
     dbh = DBI.connect("DBI:Mysql:TESTDB:localhost", 
	                    "testuser", "test123")
     sth = dbh.prepare("UPDATE EMPLOYEE SET AGE = AGE + 1
                        WHERE SEX = ?")
     sth.execute('M')
     sth.finish
     dbh.commit
rescue DBI::DatabaseError =&gt; e
     puts "An error occurred"
     puts "Error code:    #{e.err}"
     puts "Error message: #{e.errstr}"
     dbh.rollback
ensure
     # disconnect from server
     dbh.disconnect if dbh
end
</pre>
<h2>DELETE Operation:</h2>
<p>DELETE operation is required when you want to delete some records from your database. Following is the  procedure to delete all the records from EMPLOYEE where AGE is more than 20. This operation will take following steps.</p>
<ul class="list">
<li><p>Prearing SQL query based on required conditions. This will be done using <b>prepare</b> method.</p></li>
<li><p>Executing SQL query to delete required records from the database. This will be done using <b>execute</b> method.</p></li>
<li><p>Releasing Stattement handle. This will be done using <b>finish</b> method.</p></li>
<li><p>If everything goes fine then <b>commit</b> this operation otherwise you can <b>rollback</b> complete transaction.</p></li>
</ul>
<pre class="prettyprint">
#!/usr/bin/ruby -w

require "dbi"

begin
     # connect to the MySQL server
     dbh = DBI.connect("DBI:Mysql:TESTDB:localhost", 
	                    "testuser", "test123")
     sth = dbh.prepare("DELETE FROM EMPLOYEE 
                        WHERE AGE &gt; ?")
     sth.execute(20)
     sth.finish
     dbh.commit
rescue DBI::DatabaseError =&gt; e
     puts "An error occurred"
     puts "Error code:    #{e.err}"
     puts "Error message: #{e.errstr}"
     dbh.rollback
ensure
     # disconnect from server
     dbh.disconnect if dbh
end
</pre>
<h2>Performing Transactions:</h2>
<p>Transactions are a mechanism that ensures data consistency. Transactions should have the following four properties:</p>
<ul class="list">
<li><p><b>Atomicity:</b> Either a transaction completes or nothing happens at all.</p></li>
<li><p><b>Consistency:</b> A transaction must start in a consistent state and leave the system is a consistent state.</p></li>
<li><p><b>Isolation:</b> Intermediate results of a transaction are not visible outside the current transaction.</p></li>
<li><p><b>Durability:</b> Once a transaction was committed, the effects are persistent, even after a system failure.</p></li>
</ul>
<p>The DBI provides two methods to either <i>commit</i> or <i>rollback</i> a transaction.  There is one more method called <i>transaction</i> which can be used to implement transactions. There are two simple approaches to implement transactions:</p>
<h2>Approach I:</h2>
<p>The first approach uses DBI's <i>commit</i> and <i>rollback</i> methods to explicitly commit or cancel the transaction:</p>
<pre class="prettyprint">
   dbh['AutoCommit'] = false # Set auto commit to false.
   begin
     dbh.do("UPDATE EMPLOYEE SET AGE = AGE+1 
             WHERE FIRST_NAME = 'John'")
     dbh.do("UPDATE EMPLOYEE SET AGE = AGE+1 
             WHERE FIRST_NAME = 'Zara'")
     dbh.commit
   rescue
     puts "transaction failed"
     dbh.rollback
   end
   dbh['AutoCommit'] = true
</pre>
<h2>Approach II:</h2>
<p>The second approach uses the <i>transaction</i> method. This is simpler, because it takes a code block containing the statements that make up the transaction. The <i>transaction</i> method executes the block, then invokes <i>commit</i> or <i>rollback</i> automatically, depending on whether the block succeeds or fails:</p>
<pre class="prettyprint">
   dbh['AutoCommit'] = false # Set auto commit to false.
   dbh.transaction do |dbh|
     dbh.do("UPDATE EMPLOYEE SET AGE = AGE+1 
             WHERE FIRST_NAME = 'John'")
     dbh.do("UPDATE EMPLOYEE SET AGE = AGE+1 
             WHERE FIRST_NAME = 'Zara'")
   end
   dbh['AutoCommit'] = true
</pre>
<h2>COMMIT Operation:</h2>
<p>Commit is the operation which gives a green signal to database to finalize the changes and after this operation no change can be reverted back.</p>
<p>Here is a simple example to call <b>commit</b> method.</p>
<pre class="prettyprint">
     dbh.commit
</pre>
<h2>ROLLBACK Operation:</h2>
<p>If you are not satisfied with one or more of the changes and you want to revert back those changes completely then use <b>rollback</b> method.</p>
<p>Here is a simple example to call <b>rollback</b> metho.</p>
<pre class="prettyprint">
     dbh.rollback
</pre>
<h2>Disconnecting Database:</h2>
<p>To disconnect Database connection, use disconnect API.</p>
<pre class="prettyprint">
    dbh.disconnect
</pre>
<p>If the connection to a database is closed by the user with the disconnect method, any outstanding transactions are rolled back by the DBI. However, instead of depending on any of DBI's implementation details, your application would be better off calling commit or rollback explicitly.</p>
<h2>Handling Errors:</h2>
<p>There are many sources of errors. A few examples are a syntax error in an executed SQL statement, a connection failure, or calling the fetch method for an already canceled or finished statement handle.</p>
<p>If a DBI method fails, DBI raises an exception. DBI methods may raise any of several types of exception but the two most important exception classes are <i>DBI::InterfaceError</i> and <i>DBI::DatabaseError</i>.</p>
<p>Exception objects of these classes have three attributes named <i>err</i>, <i>errstr</i>, and <i>state</i>, which represent the error number, a descriptive error string, and a standard error code. The attributes are explained below:</p>
<ul class="list">
<li><p><b>err:</b> Returns an integer representation of the occurred error or <i>nil</i> if this is not supported by the DBD.The Oracle DBD for example returns the numerical part of an <i>ORA-XXXX</i> error message.</p></li>
<li><p><b>errstr:</b> Returns a string representation of the occurred error.</p></li>
<li><p><b>state:</b> Returns the SQLSTATE code of the occurred error.The SQLSTATE is a five-character-long string. Most DBDs do not support this and return nil instead.</p></li>
</ul>
<p>You have seen following code above in most of the examples:</p>
<pre class="prettyprint">
rescue DBI::DatabaseError =&gt; e
     puts "An error occurred"
     puts "Error code:    #{e.err}"
     puts "Error message: #{e.errstr}"
     dbh.rollback
ensure
     # disconnect from server
     dbh.disconnect if dbh
end
</pre>
<p>To get debugging information about what your script is doing as it executes, you can enable tracing. To do this, you must first load the dbi/trace module and then call the <i>trace</i> method that controls the trace mode and output destination:</p>
<pre class="prettyprint">
require "dbi/trace"
..............

trace(mode, destination)
</pre>
<p>The mode value may be 0 (off), 1, 2, or 3, and the destination should be an IO object. The default values are 2 and STDERR, respectively.</p>
<h2>Code Blocks with Methods</h2>
<p>There are some methods which creates handles. These methods can be invoked with a code block. The advantage of using code block along with methods is that they provide the handle to the code block as its parameter and automatically clean up the handle when the block terminates. There are few examples to understand the concept</p>
<ul class="list">
<li><p><b>DBI.connect :</b> This method generates a database handle and it is recommended to call <i>disconnect</i> at the end of the block to disconnect the database.</p></li>
<li><p><b>dbh.prepare : </b> This method generates a statement handle and it is recommended to <i>finish</i> at the end of the block. Within the block, you must invoke <i>execute</i> method to execute the statement.</p></li>
<li><p><b>dbh.execute :</b> This method is similar except we don't need to invoke execute within the block. The statement handle is automatically executed.</p></li>
</ul>
<h2>Example 1:</h2>
<p><b>DBI.connect</b> can take a code block, passes the database handle to it, and automatically disconnects the handle at the end of the block as follows.</p>
<pre class="prettyprint">
dbh = DBI.connect("DBI:Mysql:TESTDB:localhost", 
	               "testuser", "test123") do |dbh|
</pre>
<h2>Example 2:</h2>
<p><b>dbh.prepare</b> can take a code block, passes the statement handle to it, and automatically calls finish at the end of the block as follows.</p>
<pre class="prettyprint">
dbh.prepare("SHOW DATABASES") do |sth|
       sth.execute
       puts "Databases: " + sth.fetch_all.join(", ")
end
</pre>
<h2>Example 3:</h2>
<p><b>dbh.execute</b> can take a code block, passes the statement handle to it, and automatically calls finish at the end of the block as follows:</p>
<pre class="prettyprint">
dbh.execute("SHOW DATABASES") do |sth|
   puts "Databases: " + sth.fetch_all.join(", ")
end
</pre>
<p>DBI <i>transaction</i> method also takes a code block which has been described in  above.</p>
<h2>Driver-specific Functions and Attributes:</h2>
<p>The DBI lets database drivers provide additional database-specific functions, which can be called by the user through the <i>func</i> method of any Handle object.</p>
<p>Driver-specific attributes are supported and can be set or gotten using the <b>[]=</b> or <b>[]</b> methods.</p>
<p>DBD::Mysql implements the following driver-specific functions:</p>
<table class="src">
<tr><th style="width:5%">S.N.</th><th>Functions with Description</th></tr>
<tr><td>1</td><td><b>dbh.func(:createdb, db_name)</b><br />Creates a new database</td></tr>
<tr><td>2</td><td><b>dbh.func(:dropdb, db_name)</b><br />Drops a database</td></tr>
<tr><td>3</td><td><b>dbh.func(:reload)</b><br />Performs a reload operation</td></tr>
<tr><td>4</td><td><b>dbh.func(:shutdown)</b><br />Shut down the server</td></tr>
<tr><td>5</td><td><b>dbh.func(:insert_id) => Fixnum</b><br />Returns the most recent AUTO_INCREMENT value for a connection. </td></tr>
<tr><td>6</td><td><b>dbh.func(:client_info) => String</b><br />Returns MySQL client information in terms of version.</td></tr>
<tr><td>7</td><td><b>dbh.func(:client_version) => Fixnum </b><br />Returns client information in terms of version. Its similar to :client_info but it return a fixnum instead of sting.</td></tr>
<tr><td>8</td><td><b>dbh.func(:host_info) => String</b><br />Returns host information</td></tr>
<tr><td>9</td><td><b>dbh.func(:proto_info) => Fixnum</b><br />Returns protocol being used for the communication</td></tr>
<tr><td>10</td><td><b>dbh.func(:server_info) => String </b><br />Returns MySQL server information in terms of version.</td></tr>
<tr><td>11</td><td><b>dbh.func(:stat) => String</b><br />Returns current stat of the database</td></tr>
<tr><td>12</td><td><b>dbh.func(:thread_id) => Fixnum</b><br />Return current thread ID.</td></tr>
</table>
<h2>Example:</h2>
<pre class="prettyprint">
#!/usr/bin/ruby

require "dbi"
begin
   # connect to the MySQL server
   dbh = DBI.connect("DBI:Mysql:TESTDB:localhost", 
	                    "testuser", "test123") 
   puts dbh.func(:client_info)
   puts dbh.func(:client_version)
   puts dbh.func(:host_info)
   puts dbh.func(:proto_info)
   puts dbh.func(:server_info)
   puts dbh.func(:thread_id)
   puts dbh.func(:stat)
rescue DBI::DatabaseError =&gt; e
   puts "An error occurred"
   puts "Error code:    #{e.err}"
   puts "Error message: #{e.errstr}"
ensure
   dbh.disconnect if dbh
end
</pre>
<p>This will produce following result:</p>
<pre class="prettyprint">
5.0.45
50045
Localhost via UNIX socket
10
5.0.45
150621
Uptime: 384981  Threads: 1  Questions: 1101078  Slow queries: 4 \
Opens: 324  Flush tables: 1  Open tables: 64  \
Queries per second avg: 2.860
</pre>
<hr />
<div class="pre-btn">
<a href="ruby_regular_expressions.htm">Previous Page</a>
</div>
<div class="print-btn">
<a href="../cgi-bin/printpage.html" target="_blank">Print Version</a>
</div>
<div class="pdf-btn">
<a href="pdf/ruby_database_access.pdf" alt="Ruby/DBI Tutorial" target="_blank">PDF Version</a>
</div>
<div class="nxt-btn">
<a href="ruby_web_applications.htm">Next Page</a>
</div>
<div class="clearer"></div>
<hr />
</div>
<!-- PRINTING ENDS HERE -->
<div class="bottomgooglead">
<div style="padding-bottom:5px;padding-left:10px;">Advertisements</div>
<script type="text/javascript"><!--
google_ad_client = "pub-7133395778201029";
google_ad_width = 336;
google_ad_height = 280;
google_ad_format = "336x280_as";
google_ad_type = "text";
google_ad_channel ="9030538898";
google_color_border="ffffff";
google_color_link="900b09";
google_color_url="000000";
google_color_text="000000";
//--></script>
<script type="text/javascript" src="../../pagead2.googlesyndication.com/pagead/show_ads.js"></script>
</div>
</div><!-- middlecol -->
<div id="rightcol">
<!-- AddThis Button BEGIN -->
<div class="addthis">
<div class="addthis_toolbox addthis_default_style">
<a class="addthis_button_facebook"></a>
<a class="addthis_button_twitter"></a>
<script type="text/javascript">
<!--
 document.write('<a class="addthis_button_google_plusone" g:plusone:count="false"></a>');
//-->
</script>
<a class="addthis_button_linkedin"></a>
<a class="addthis_button_email"></a>
<a class="addthis_button_compact"></a>
</div>
<script type="text/javascript" src="../../s7.addthis.com/js/250/addthis_widget.js#pubid=ra-4f661ec623a400f0"></script>
</div>
<!-- AddThis Button END -->
<div class="localad">
<a rel="nofollow" href="http://www.modernindianbabynames.com/" target="_blank" title="Modern Baby Names">Modern Baby Names</a>
</div>
<div class="localad">
<a rel="nofollow" href="http://www.photofuntoos.com/" target="_blank" title="Online Photo Editing">Online Photo Editing</a>
</div>
<div class="rightgooglead">
<div style="padding-bottom:5px;padding-left:10px;">Advertisements</div>
<script type="text/javascript"><!--
google_ad_client = "pub-7133395778201029";
google_ad_width = 160;
google_ad_height = 600;
google_ad_format = "160x600_as";
google_ad_type = "image";
google_ad_channel ="";
//--></script>
<script type="text/javascript"
src="../../pagead2.googlesyndication.com/pagead/show_ads.js"> 
</script>
</div>
</div><!-- rightcol -->
<div style="clear:both;"></div>
</div><!-- wrapper -->
<div id="footer">
<div class="wrapper">
<div id="bottommenu">
<a href="../asp.net/index.htm" target="_top">ASP.NET </a> |
<a href="../jquery/index.htm" target="_top">jQuery </a> |
<a href="../ajax/index.htm" target="_top">AJAX </a> |
<a href="../ant/index.htm" target="_top">ANT</a> |
<a href="../jsp/index.htm" target="_top">JSP </a> |
<a href="../servlets/index.htm" target="_top">Servlets </a> |
<a href="../log4j/index.htm" target="_top">log4j </a> |
<a href="../ibatis/index.htm" target="_top">iBATIS </a> |
<a href="../hibernate/index.htm" target="_top">Hibernate </a> |
<a href="../jdbc/index.htm" target="_top">JDBC </a> |
<a href="../struts_2/index.htm" target="_top">Struts </a> |
<a href="../html5/index.htm" target="_top">HTML5 </a> |
<a href="../sql/index.htm" target="_top">SQL </a> |
<a href="../mysql/index.htm" target="_top">MySQL </a> |
<a href="../cplusplus/index.htm" target="_top">C++ </a> |
<a href="../unix/index.htm" target="_top">UNIX </a>
</div>
<div id="copyright">
<p>Copyright &copy; 2013 by tutorialspoint. All Rights Reserved.</p>
</div>
</div>
</div>
</body>

<!-- Mirrored from www.tutorialspoint.com/ruby/ruby_database_access.htm by HTTrack Website Copier/3.x [XR&CO'2010], Sat, 13 Apr 2013 19:45:58 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
</html>